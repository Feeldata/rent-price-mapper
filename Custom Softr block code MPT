
<div style="padding:15px;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:10px;border-radius:8px;">
  <div style="display:flex;gap:15px;align-items:center;font-family:Arial;flex-wrap:wrap;">
    <label style="display:flex;align-items:center;gap:8px;font-weight:bold;background:#f0f0f0;padding:8px 15px;border-radius:20px;cursor:pointer;">
      <input type="checkbox" id="toggleView" onchange="switchView()">
      Vue Quartiers
    </label>
    
    <div id="filterControls" style="display:flex;gap:15px;align-items:center;">
      <label style="font-weight:bold;">Chambres:</label>
      <select id="filterChambres" style="padding:8px;border-radius:4px;border:1px solid #ccc;">
        <option value="">Tous</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
      
      <label style="font-weight:bold;margin-left:20px;">Quartier:</label>
      <select id="filterQuartier" style="padding:8px;border-radius:4px;border:1px solid #ccc;">
        <option value="">Tous</option>
      </select>
      
      <button onclick="applyFilters()" style="padding:8px 20px;background:#3388ff;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Filtrer</button>
      <span id="resultCount" style="margin-left:15px;color:#666;"></span>
    </div>
  </div>
</div>

<div id="map" style="height:600px;width:100%;"></div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
var map,allMarkers=[],allData=[],qLayer,viewMode='points';
setTimeout(function(){
map=L.map('map').setView([43.6108,3.8767],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

console.log('Chargement données...');
fetchAllRecords();

var leg=L.control({position:'bottomright'});
leg.onAdd=function(){
  var d=L.DomUtil.create('div','legend');
  d.innerHTML='<div style="padding:12px;background:white;box-shadow:0 2px 10px rgba(0,0,0,0.3);border-radius:8px;font-family:Arial;"><h4 style="margin:0 0 10px;">Prix</h4><span style="display:block;margin:4px 0;"><i style="display:inline-block;width:18px;height:18px;background:#d73027;border-radius:50%;margin-right:8px;vertical-align:middle;"></i>> 1200€</span><span style="display:block;margin:4px 0;"><i style="display:inline-block;width:18px;height:18px;background:#fc8d59;border-radius:50%;margin-right:8px;vertical-align:middle;"></i>900-1200€</span><span style="display:block;margin:4px 0;"><i style="display:inline-block;width:18px;height:18px;background:#fee08b;border-radius:50%;margin-right:8px;vertical-align:middle;"></i>700-900€</span><span style="display:block;margin:4px 0;"><i style="display:inline-block;width:18px;height:18px;background:#91cf60;border-radius:50%;margin-right:8px;vertical-align:middle;"></i>< 700€</span></div>';
  return d;
};
leg.addTo(map);
},1500);

function fetchAllRecords(offset){
var url='YOUR BASE_ID';
if(offset)url+='&offset='+offset;

fetch(url,{
  headers:{Authorization:'YOUR TOKEN'}
})
.then(r=>r.json())
.then(d=>{
  allData=allData.concat(d.records);
  console.log('Chargé:',d.records.length,'| Total:',allData.length);
  
  if(d.offset){
    fetchAllRecords(d.offset);
  }else{
    console.log('TOTAL FINAL:',allData.length,'annonces');
    
    var qs=new Set();
    allData.forEach(r=>{if(r.fields.QUARTIERS)qs.add(r.fields.QUARTIERS)});
    var sel=document.getElementById('filterQuartier');
    Array.from(qs).sort().forEach(q=>{
      var o=document.createElement('option');
      o.value=q;o.textContent=q;
      sel.appendChild(o);
    });
    
    renderMarkers(allData);
    loadQuartiers();
  }
})
.catch(e=>console.error('Erreur:',e));
}

function loadQuartiers(){
console.log('Chargement GeoJSON...');
fetch('https://gist.githubusercontent.com/lucienisaac26-tech/ed0eb031981ea6c4cd4c4244b1757724/raw/montpellier_quartiers.geojson')
.then(r=>r.json())
.then(gj=>{
  console.log('GeoJSON chargé:',gj.features.length,'quartiers');
  qLayer=L.geoJSON(gj,{
    style:function(){return{color:'#999',weight:2,fillOpacity:0}},
    onEachFeature:function(f,l){
      var n=f.properties.name||f.properties.nom;
      if(n){
        var s=calcStats(n);
        if(s.count>0){
          var c=getColor(s.avgPrix);
          l.setStyle({fillColor:c,fillOpacity:0.6});
          l.bindPopup('<div style="padding:10px;font-family:Arial;"><b style="font-size:18px;">'+n+'</b><br><span style="color:#666;">'+s.count+' annonces</span><br><b style="font-size:16px;color:'+c+';">Prix moyen: '+Math.round(s.avgPrix)+'€</b><br><span style="color:#666;">Chambres moy: '+s.avgChambres.toFixed(1)+'</span><br><span style="color:#666;">Surface moy: '+Math.round(s.avgSurface)+'m²</span></div>');
        }
      }
    }
  });
}).catch(e=>console.error('Erreur GeoJSON:',e));
}

function calcStats(qn){
var m=allData.filter(r=>r.fields.QUARTIERS&&r.fields.QUARTIERS.toLowerCase().includes(qn.toLowerCase()));
if(m.length===0)return{count:0};
var sp=0,sc=0,ss=0,cc=0,cs=0;
m.forEach(r=>{
  if(r.fields.PRIX)sp+=r.fields.PRIX;
  if(r.fields.Chambres){sc+=parseFloat(r.fields.Chambres)||0;cc++;}
  if(r.fields.SURFACE_M2){ss+=r.fields.SURFACE_M2;cs++;}
});
return{count:m.length,avgPrix:sp/m.length,avgChambres:cc>0?sc/cc:0,avgSurface:cs>0?ss/cs:0};
}

function getColor(p){return p>1200?'#d73027':p>900?'#fc8d59':p>700?'#fee08b':'#91cf60'}

function switchView(){
var c=document.getElementById('toggleView').checked;
viewMode=c?'quartiers':'points';
if(viewMode==='quartiers'){
  allMarkers.forEach(m=>map.removeLayer(m));
  if(qLayer)map.addLayer(qLayer);
  document.getElementById('filterControls').style.display='none';
  document.getElementById('resultCount').textContent='';
}else{
  if(qLayer)map.removeLayer(qLayer);
  renderMarkers(allData);
  document.getElementById('filterControls').style.display='flex';
}
}

function renderMarkers(recs){
allMarkers.forEach(m=>map.removeLayer(m));
allMarkers=[];
var cnt=0;
recs.forEach(r=>{
  var f=r.fields;
  if(f.LAT&&f.LONG&&f.PRIX){
    cnt++;
    var c=getColor(f.PRIX);
    var m=L.circleMarker([f.LAT,f.LONG],{radius:8,fillColor:c,color:'white',weight:2,fillOpacity:0.9}).addTo(map);
    m.bindPopup('<div style="padding:8px;font-family:Arial;"><b style="font-size:16px;">'+(f.QUARTIERS||'Montpellier')+'</b><br><span style="color:#666;">'+(f.Chambres||'?')+' ch - '+(f.SURFACE_M2||'?')+'m²</span><br><b style="font-size:18px;color:'+c+';">'+f.PRIX+'€</b></div>');
    allMarkers.push(m);
  }
});
document.getElementById('resultCount').textContent=cnt+' annonces';
}

function applyFilters(){
if(viewMode==='quartiers')return;
var fc=document.getElementById('filterChambres').value;
var fq=document.getElementById('filterQuartier').value;
var filt=allData.filter(r=>{
  var f=r.fields;
  return(!fc||String(f.Chambres)===fc)&&(!fq||f.QUARTIERS===fq);
});
renderMarkers(filt);
}
</script>
